<!doctype HTML>
<html>
<head>
<title>3D Tree Creator</title>
<style>
body{
color:white;
}
canvas{
position:relative;
}
#can0{
border:2px solid #333;
}

#display{
z-index:2;
position:relative;
font-family: menlo, sans-serif;
color:#0f0;
left:400px;
bottom:140px;
}

#display td{
background-color: black;
width:99px;
padding:0px;
border-radius:4px;
text-align:center;
}
#display_spd,#display_alt{
height:75px;
font-size:1.5em;
}
.check{
vertical-align:top;

}
.colorbox{
width:12px;
height:12px;
display:inline-block;
}
</style>
</head>
<body bgcolor="#222222" onload="init()">
<canvas height="600" width="1000" id="can0" onclick=""></canvas>

<br>

<button onclick="tree()">New Tree</button><br>
Size (recursions)<input type="text" size="10" id="input1" value="15"><br>
Max Children<input type="text" size="10" id="input2" value="2"><br>
Child Length Decrease<input type="text" size="10" id="input3" value="1.25"><br>
<table>
<tr>
<td>Color 1 RGB</td>
<td><input type="text" size="3" id="r1" value="102" onchange="updateColors()"></td>
<td><input type="text" size="3" id="g1" value="51" onchange="updateColors()"></td>
<td><input type="text" size="3" id="b1" value="0" onchange="updateColors()"></td>
<td><span class="colorbox"></span></td>
</tr>
<tr>
<td>Color 2 RGB</td>
<td><input type="text" size="3" id="r2" value="30" onchange="updateColors()"></td>
<td><input type="text" size="3" id="g2" value="140" onchange="updateColors()"></td>
<td><input type="text" size="3" id="b2" value="10" onchange="updateColors()"></td>
<td><span class="colorbox"></span></td>
</tr>
</table>
<span class="check">
Branch Width Perspective:
<input class="check" checked="true" type="checkbox" onchange="widen=this.checked"></span>
<table id="display">
<tr><td id="display_spd">-</td><td id="display_alt">-</td></tr>
<tr><td>Speed</td><td>Altitude</td></tr>
<tr></tr>
</table>

<script type="text/javascript">
var can,can1,can1_1,can2,can3,can3_1;
var ctx;
var points=[];
var block=[];
var key={up:false,down:false,left:false,right:false,space:false,a:false,s:false,w:false,z:false};
var fps=20;
var renderdist=200;
var widen=true;

var eye={x:0,y:60,z:0,speed:0,
xang:0,yang:0,zang:0,
xangvel:0,yangvel:0,zangvel:0,
move(){
	this.xang+=this.xangvel;
	this.yang+=this.yangvel;
	this.zang+=this.zangvel;
	this.xang=anglemod(this.xang);
	this.yang=anglemod(this.yang);
	this.zang=anglemod(this.zang);
	if(Math.abs(this.xang)>Math.PI/2&&0){
	this.xang=Math.sign(this.xang)*(Math.PI-Math.abs(this.xang));
	this.yang-=(Math.sign(this.yang)||1)*Math.PI;
	this.zang-=(Math.sign(this.zang)||1)*Math.PI;
	}
	this.x+=this.speed*Math.sin(this.yang)*Math.cos(this.xang);
	this.y+=this.speed*Math.sin(this.xang);
	this.z+=this.speed*Math.cos(this.yang)*Math.cos(this.xang);
}

};
var zoom=400;
var MX,MY;


var diag=[];

function anglemod(a){//returns angle in [-pi,pi)
return ((a+Math.PI)%(2*Math.PI)-Math.PI*(Math.sign(a+Math.PI)||1));
}

var offset;
function animate(){
setInterval(Frame,1000/fps)
}
function kdown(e){
	var event=window.event ? window.event : e;
	if(event.keyCode===37){event.preventDefault();key.left=true}
	if(event.keyCode===38){event.preventDefault();key.up=true}
	if(event.keyCode===39){event.preventDefault();key.right=true}
	if(event.keyCode===40){event.preventDefault();key.down=true}
	if(event.keyCode===32){event.preventDefault();key.space=true}
	if(event.keyCode===65){event.preventDefault();key.a=true}
	if(event.keyCode===83){event.preventDefault();key.s=true}
	if(event.keyCode===68){event.preventDefault();key.d=true}
	if(event.keyCode===87){event.preventDefault();key.w=true}
	if(event.keyCode===90){event.preventDefault();key.z=true}
}
function kup(e){
	var event=window.event ? window.event : e;
	if(event.keyCode===37){key.left=false}
	if(event.keyCode===38){key.up=false}
	if(event.keyCode===39){key.right=false}
	if(event.keyCode===40){key.down=false}
	if(event.keyCode===32){key.space=false}
	if(event.keyCode===65){key.a=false}
	if(event.keyCode===83){key.s=false}
	if(event.keyCode===68){key.d=false}
	if(event.keyCode===87){key.w=false}
	if(event.keyCode===90){key.z=false}
}
function getPoint(p){
	var disp=[p[0]-eye.x,p[1]-eye.y,p[2]-eye.z];

	var c1=Math.cos(eye.yang);
	var c2=Math.cos(eye.xang);
	var c3=Math.cos(eye.zang);
	var s1=Math.sin(eye.yang);
	var s2=-Math.sin(eye.xang);
	var s3=Math.sin(eye.zang);

	var d=[(c1*c3+s1*s2*s3)*disp[0]+c2*s3*disp[1]+(c1*s2*s3-c3*s1)*disp[2],
	(c3*s1*s2-c1*s3)*disp[0]+c2*c3*disp[1]+(s1*s3+c1*c3*s2)*disp[2],
	c2*s1*disp[0]-s2*disp[1]+c1*c2*disp[2]];//passive Y-X'-Z" rotation, i.e. heading, pitch, roll
	if((d[2])>0){
	return [zoom*d[0]/d[2],zoom*d[1]/d[2]];
	}else{
	return [zoom*zoom*zoom*d[0],zoom*zoom*zoom*d[1]];
	}
}
function init(){
	can=document.getElementById("can0");
	ctx=can.getContext("2d");
	//can0.addEventListener("mousemove",function(){var e=window.event ? window.event:e;MX=(e.offsetX-500)/zoom;MY=(300-e.offsetY)/zoom;});
	document.addEventListener("keydown",kdown);
	document.addEventListener("keyup",kup);
	
	ctx.fillStyle="#000";
	
	animate();
	tree();
}
function tree(){
	updateColors();
	branchcount=1;
	size=parseInt(document.getElementById("input1").value);
	maxchildren=parseFloat(document.getElementById("input2").value);;
	ldc=parseFloat(document.getElementById("input3").value);

	seed=new Branch(0,0,100,20,0,0,size);
	seed.populate();
	seed.draw();
}
var branchcount;
var r1,g1,b1,r2,g2,b2;
var seed;
var size=15;//number of recursions
var maxchildren=2;
var ldc=1.25;//length decrease factor 

function gradient(x){
//return "rgba("+Math.ceil(r2+x*(r1-r2))+","+Math.ceil(g2+x*(g1-g2))+","+Math.ceil(b2+x*(b1-b2))+","+1+")";
return "rgb("+Math.ceil(r2+x*(r1-r2))+","+Math.ceil(g2+x*(g1-g2))+","+Math.ceil(b2+x*(b1-b2))+")";
}
function Branch(x,y,z,len,azi,ele,lifespan){

	this.x=x;
	this.y=y;
	this.z=z;
	this.len=len;
	this.azi=azi;
	this.ele=ele;
	this.lifespan=lifespan;
	this.children=[];
	
	this.draw=function(){
		ctx.strokeStyle=gradient(this.lifespan/size);
		if(widen){
			var dist=(1)/Math.sqrt((this.x-eye.x)*(this.x-eye.x)+(this.y-eye.y)*(this.y-eye.y)+(this.z-eye.z)*(this.z-eye.z));
			ctx.lineWidth=this.lifespan>-1?Math.ceil(500*this.lifespan*dist/size):(Math.ceil(300*dist));			
		}else{
			ctx.lineWidth=Math.ceil(5*this.lifespan/size);
		}
		
		var startpoint=getPoint([this.x,this.y,this.z]);
		var endpoint=getPoint([this.x+this.len*Math.sin(this.ele)*Math.cos(this.azi),
										this.y+this.len*Math.cos(this.ele),
										this.z+this.len*Math.sin(this.ele)*Math.sin(this.azi)])
		ctx.beginPath();
		ctx.moveTo(500+startpoint[0],300-startpoint[1]);
		ctx.lineTo(500+endpoint[0],300-endpoint[1]);
		ctx.stroke();
		for(var i=0;i<this.children.length;i++){
			this.children[i].draw();
		}
	}
	this.populate=function(){
		if(this.lifespan<0){
			this.lifespan=0;
		}
		this.children=[];
		if(this.lifespan>0){
		var n=Math.ceil(Math.random()*maxchildren);
		for(var i=0;i<n;i++){
			var a=Math.random()*Math.PI;
			var b=Math.random()*Math.PI/2-Math.PI/4;//Math.PI/(2*size);
			this.children.push(new Branch(this.x+this.len*Math.sin(this.ele)*Math.cos(this.azi),
										this.y+this.len*Math.cos(this.ele),
										this.z+this.len*Math.sin(this.ele)*Math.sin(this.azi),
			this.len/(ldc),this.azi+(a*Math.cos(this.ele)),this.ele+b,lifespan-1));
			this.children[i].populate();
			branchcount++;
		}
		}
	}
}
function updateColors(){
	r1=parseInt(document.getElementById("r1").value);
	g1=parseInt(document.getElementById("g1").value);
	b1=parseInt(document.getElementById("b1").value);
	r2=parseInt(document.getElementById("r2").value);
	g2=parseInt(document.getElementById("g2").value);
	b2=parseInt(document.getElementById("b2").value);
	document.getElementsByClassName("colorbox")[0].style.backgroundColor="rgb("+r1+","+g1+","+b1+")";
	document.getElementsByClassName("colorbox")[1].style.backgroundColor="rgb("+r2+","+g2+","+b2+")";
}

function Frame(){		
		if(key.up&&!key.down){
			eye.xang+=Math.cos(eye.zang)*Math.PI/(4*fps);
			eye.yang-=Math.sin(eye.zang)*Math.PI/(4*fps);
		}else if(key.down){
			eye.xang-=Math.cos(eye.zang)*Math.PI/(4*fps);
			eye.yang+=Math.sin(eye.zang)*Math.PI/(4*fps);
		}else{
		}
		if(key.left&&!key.right){
			eye.yang-=Math.cos(eye.zang)*Math.PI/(4*fps);
			eye.xang-=Math.sin(eye.zang)*Math.PI/(4*fps);
			//eye.zang+=Math.sin(eye.xang)*Math.PI/120;
		}else if(key.right){
			eye.yang+=Math.cos(eye.zang)*Math.PI/(4*fps);
			eye.xang+=Math.sin(eye.zang)*Math.PI/(4*fps);
			//eye.zang-=Math.sin(eye.xang)*Math.PI/120;
		}else{
		}
		if(key.w){
			eye.speed=80/fps;
		}else if(key.s){
			eye.speed=-80/fps;
		}else{
			eye.speed=0;
		}
		
		if(key.a&&!key.d){
			eye.x-=3*Math.cos(eye.yang);
			eye.z+=3*Math.sin(eye.yang);
		}else if(key.d){
			eye.x+=3*Math.cos(eye.yang);
			eye.z-=3*Math.sin(eye.yang);		
			}
		if(key.z){
				eye.speed=0.1;		
		}
			
	eye.move();
	ctx.fillRect(0,0,1000,600);
	document.getElementById("display_spd").innerHTML=eye.speed.toFixed(2);
	document.getElementById("display_alt").innerHTML=eye.y.toFixed(2);
	
	seed.draw();
}


</script>
</body>
</html>
